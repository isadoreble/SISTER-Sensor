<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smart Apartment Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 16px;
      margin: 0;
      background: #fafafa;
    }
    header {
      margin-bottom: 16px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    header h1 {
      margin: 0;
    }
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 14px;
    }
    select, button {
      padding: 4px 8px;
      font-size: 13px;
      cursor: pointer;
    }
    .layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
    }
    .charts-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    .card {
      background: #fff;
      padding: 12px 16px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .card h3 {
      margin-top: 0;
      font-size: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card h3 span.actions {
      font-size: 12px;
      display: flex;
      gap: 6px;
    }
    .card h2 {
      margin-top: 0;
      font-size: 18px;
    }
    .footer {
      margin-top: 8px;
      font-size: 12px;
      color: #777;
    }
    .device-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }
    .device-card {
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 8px;
      font-size: 13px;
    }
    .device-card h4 {
      margin: 0 0 4px 0;
      font-size: 14px;
    }
    .device-control-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
    }
    .device-control-line label {
      font-size: 12px;
    }
    .toggle {
      width: 40px;
      height: 18px;
    }
    .alert-box {
      padding: 8px 10px;
      border-radius: 6px;
      font-size: 13px;
      margin-bottom: 8px;
      display: none;
    }
    .alert-active {
      display: block;
      background: #ffe5e5;
      border: 1px solid #ff8e8e;
      color: #a00000;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #eee;
      padding: 4px 6px;
      text-align: left;
    }
    th {
      background: #f3f3f3;
    }

    /* Fullscreen chart modal */
    .fullscreen-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .fullscreen-content {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .fullscreen-content header {
      margin: 0;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
    }
    .fullscreen-content canvas {
      max-height: 70vh;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

<header>
  <h1>Smart Apartment Monitoring</h1>
  <div class="header-row">
    <div>
      <div id="lastUpdateText">Last update: -</div>
      <div id="nowText">Current time: -</div>
    </div>
    <div>
      Range:
      <select id="timeRange">
        <option value="10min">Last 10 minutes</option>
        <option value="1h">Last 1 hour</option>
        <option value="today" selected>Today (24h)</option>
        <option value="7d">Last 7 days</option>
      </select>
      <button id="exportCsvBtn">Export CSV</button>
    </div>
  </div>
</header>

<div class="layout">
  <!-- LEFT: CHARTS -->
  <section class="charts-grid">
    <div class="card">
      <h3>
        Gas Level (PPM) vs Time
        <span class="actions">
          <button onclick="openFullscreen('gas')">Fullscreen</button>
        </span>
      </h3>
      <canvas id="gasChart"></canvas>
    </div>

    <div class="card">
      <h3>
        Light Level vs Time
        <span class="actions">
          <button onclick="openFullscreen('light')">Fullscreen</button>
        </span>
      </h3>
      <canvas id="lightChart"></canvas>
    </div>
  </section>

  <!-- RIGHT: DEVICES + ALERTS + LOGS -->
  <section>
    <div class="card">
      <h2>Device Control Panel</h2>
      <div class="device-row">
        <!-- Lamp -->
        <div class="device-card">
          <h4>Lamp</h4>
          <div class="device-control-line">
            <label>Mode:</label>
            <select id="lampModeSelect">
              <option value="auto">Auto (LDR)</option>
              <option value="manual">Manual</option>
            </select>
          </div>
          <div class="device-control-line">
            <label>Status:</label>
            <input type="checkbox" id="lampToggle" class="toggle">
          </div>
        </div>

        <!-- Buzzer -->
        <div class="device-card">
          <h4>Buzzer</h4>
          <div class="device-control-line">
            <label>Mode:</label>
            <span>Auto (Gas)</span>
          </div>
          <div class="device-control-line">
            <label>Status:</label>
            <input type="checkbox" id="buzzerToggle" class="toggle" disabled>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Alerts & Logs</h2>
      <div id="alertBox" class="alert-box"></div>
      <div style="max-height: 230px; overflow-y: auto;">
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>Type</th>
              <th>Message</th>
            </tr>
          </thead>
          <tbody id="logTableBody"></tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<!-- Fullscreen overlay -->
<div id="fullscreenOverlay" class="fullscreen-overlay">
  <div class="fullscreen-content">
    <header>
      <h3 id="fullscreenTitle">Chart</h3>
      <button onclick="closeFullscreen()">Close</button>
    </header>
    <canvas id="fullscreenCanvas"></canvas>
  </div>
</div>

<script>
  // =============================
  // FIREBASE CONFIG
  // =============================
  const firebaseConfig = {
    databaseURL: "https://sisdig-apartment-default-rtdb.firebaseio.com"
  };
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  // ----------------------------------------
  // SAMPLE DATA & CHARTS
  // ----------------------------------------
  const MAX_POINTS = 20;
  const labels = [];   
  const gasData  = [];
  const lightData= [];

  function formatTimeHM(now) {
    return now.toLocaleTimeString("id-ID", {
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: false
    });
  }

  function initData() {
    const now = new Date();
    for (let i = 0; i < 5; i++) {
      const t = new Date(now.getTime() - (5 - i) * 60000); 
      labels.push(formatTimeHM(t));
      gasData.push(350 + Math.random() * 300); 
      lightData.push(10 + Math.random() * 80); 
    }
  }
  initData();

  function createChart(ctx, data, label) {
    return new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: [{
          label: label,
          data: data,
          tension: 0.35,
          borderWidth: 2,
          fill: false
        }]
      },
      options: {
        responsive: true,
        animation: false,
        scales: {
          x: { title: { display: true, text: "Time" } },
          y: { beginAtZero: true }
        }
      }
    });
  }

  const gasChart = createChart(
    document.getElementById("gasChart"),
    gasData,
    "Gas Level (PPM)"
  );

  const lightChart = createChart(
    document.getElementById("lightChart"),
    lightData,
    "Light Level"
  );

  // ----------------------------------------
  // TIME DISPLAY
  // ----------------------------------------
  function updateTimeTexts() {
    const now = new Date();
    const formatter = new Intl.DateTimeFormat("id-ID", {
      dateStyle: "short",
      timeStyle: "medium",
      timeZone: "Asia/Jakarta"
    });
    document.getElementById("nowText").innerText =
      "Current time: " + formatter.format(now) + " WIB";
  }
  function updateLastUpdateText() {
    const now = new Date();
    const formatter = new Intl.DateTimeFormat("id-ID", {
      dateStyle: "short",
      timeStyle: "medium",
      timeZone: "Asia/Jakarta"
    });
    document.getElementById("lastUpdateText").innerText =
      "Last update: " + formatter.format(now) + " WIB";
  }
  updateTimeTexts();
  setInterval(updateTimeTexts, 1000);

  // ----------------------------------------
  // LOG SYSTEM
  // ----------------------------------------
  const logTableBody = document.getElementById("logTableBody");
  function addLog(type, message) {
    const now = new Date();
    const timeText = now.toLocaleTimeString("id-ID", {
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: false
    });

    const row = document.createElement("tr");
    row.innerHTML = `<td>${timeText}</td><td>${type}</td><td>${message}</td>`;
    logTableBody.prepend(row);
  }

  // ----------------------------------------
  // GAS ALERT & BUZZER CONTROL
  // ----------------------------------------
  const GAS_THRESHOLD = 600;
  const alertBox = document.getElementById("alertBox");
  const buzzerToggle = document.getElementById("buzzerToggle");

  function checkGasAlert() {
    const latestGas = gasData[gasData.length - 1] || 0;
    if (latestGas >= GAS_THRESHOLD) {
      alertBox.className = "alert-box alert-active";
      alertBox.textContent =
        "GAS ALERT: " + latestGas.toFixed(0) + " PPM (>= " + GAS_THRESHOLD + " PPM). Buzzer ON.";
      buzzerToggle.checked = true;
      addLog("ALERT", "Gas high: " + latestGas.toFixed(0) + " PPM. Buzzer ON.");
    } else {
      alertBox.className = "alert-box";
      alertBox.textContent = "";
      buzzerToggle.checked = false;
    }
  }

  // ----------------------------------------
  // DEVICE CONTROL PANEL (Lamp)
  // ----------------------------------------
  const lampModeSelect = document.getElementById("lampModeSelect");
  const lampToggle     = document.getElementById("lampToggle");

  lampModeSelect.addEventListener("change", () => {
    addLog("DEVICE", "Lamp mode changed to " + lampModeSelect.value.toUpperCase());
  });

  lampToggle.addEventListener("change", () => {
    if (lampModeSelect.value === "auto") {
      lampToggle.checked = !lampToggle.checked; 
      addLog("DEVICE", "Lamp is AUTO. Manual toggle ignored.");
    } else {
      addLog("DEVICE", "Lamp turned " + (lampToggle.checked ? "ON" : "OFF") + " (Manual).");
    }
  });

  // =============================
  // FIREBASE REALTIME LISTENER
  // =============================
  const sensorRef = database.ref("sensor");
  sensorRef.on("value", (snapshot) => {
    const data = snapshot.val();
    if (!data) return;

    const now = new Date();
    const timeLabel = formatTimeHM(now);

    const gas  = data.gas;
    const ldr  = data.ldr;

    labels.push(timeLabel);
    gasData.push(gas);
    lightData.push(ldr);

    if (labels.length > MAX_POINTS) {
      labels.shift();
      gasData.shift();
      lightData.shift();
    }

    gasChart.update();
    lightChart.update();

    updateLastUpdateText();
    checkGasAlert();
  });

  // ----------------------------------------
  // EXPORT CSV
  // ----------------------------------------
  document.getElementById("exportCsvBtn").addEventListener("click", () => {
    let csv = "Time,Gas (PPM),Light Level\n";
    for (let i = 0; i < labels.length; i++) {
      const line = [
        labels[i],
        (gasData[i] ?? "").toFixed ? gasData[i].toFixed(0) : gasData[i],
        (lightData[i] ?? "").toFixed ? lightData[i].toFixed(0) : lightData[i]
      ].join(",");
      csv += line + "\n";
    }

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url  = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = "smart_apartment_data.csv";
    link.click();
    URL.revokeObjectURL(url);
  });

  // ----------------------------------------
  // FULLSCREEN CHART
  // ----------------------------------------
  const fullscreenOverlay = document.getElementById("fullscreenOverlay");
  const fullscreenCanvas  = document.getElementById("fullscreenCanvas");
  const fullscreenTitle   = document.getElementById("fullscreenTitle");
  let fullscreenChartInstance = null;

  function cloneChartConfig(sourceChart) {
    return {
      type: sourceChart.config.type,
      data: {
        labels: [...sourceChart.data.labels],
        datasets: sourceChart.data.datasets.map(ds => ({...ds, data: [...ds.data]}))
      },
      options: {...sourceChart.options, responsive: true, animation: false}
    };
  }

  function openFullscreen(type) {
    let sourceChart;
    let titleText;

    if (type === "gas") {
      sourceChart = gasChart;
      titleText = "Gas Level (PPM) vs Time";
    } else {
      sourceChart = lightChart;
      titleText = "Light Level vs Time";
    }

    if (fullscreenChartInstance) fullscreenChartInstance.destroy();
    fullscreenTitle.textContent = titleText;

    fullscreenChartInstance = new Chart(fullscreenCanvas, cloneChartConfig(sourceChart));
    fullscreenOverlay.style.display = "flex";
  }

  function closeFullscreen() {
    fullscreenOverlay.style.display = "none";
    if (fullscreenChartInstance) fullscreenChartInstance.destroy();
    fullscreenChartInstance = null;
  }

  window.openFullscreen = openFullscreen;
  window.closeFullscreen = closeFullscreen;
</script>
</body>
</html>